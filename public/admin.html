<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Credits Management</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto; background:#0b0c10;color:#eaf0f6; min-height:100vh; display:flex; align-items:center; justify-content:center}
    .wrap{width:100%;max-width:680px;background:#12151b;border:1px solid #1f2633;border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;color:#77bdfb;margin-bottom:12px}
    .grid{display:grid;gap:14px}
    label{display:block;font-weight:600;color:#c7d3e0;margin-bottom:6px}
    input[type="number"]{width:100%;background:#0d1117;border:1px solid #283142;color:#eaf0f6;padding:10px 12px;border-radius:10px;font-size:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#2b6cb0;border:none;color:#fff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .stat{background:#0d1117;border:1px solid #283142;border-radius:10px;padding:8px 12px;font-size:13px;color:#9fb3c8}
    .list{margin-top:14px;background:#0d1117;border:1px solid #283142;border-radius:10px;padding:12px; max-height:360px; overflow:auto}
    .item{border-bottom:1px dashed #283142;padding:8px 0; font-size:12px}
    .item:last-child{border-bottom:none}
    .type{color:#9fb3c8;margin-right:6px}
    .table-container{margin-top:14px;background:#0d1117;border:1px solid #283142;border-radius:10px;overflow:auto;max-height:400px}
    .data-table{width:100%;border-collapse:collapse;font-size:12px}
    .data-table th{background:#1a1f2a;color:#77bdfb;padding:8px 6px;text-align:left;border-bottom:1px solid #283142;font-weight:600;position:sticky;top:0}
    .data-table td{padding:6px;border-bottom:1px solid #283142;color:#c7d3e0}
    .data-table tr:hover{background:#1a1f2a}
    .status-sent{color:#4ade80}
    .status-failed{color:#f87171}
    .status-delivered{color:#4ade80}
    .status-undeliverable{color:#f87171}
    .status-pending{color:#fbbf24}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin - Credits & Logs</h1>

    <div class="row" style="margin:8px 0 12px">
      <div class="stat" id="credits">Current credits: --</div>
      <button class="btn" id="refresh">Refresh</button>
    </div>

    <div class="grid">
      <div>
        <label for="setVal">Set credits (integer)</label>
        <div class="row">
          <input id="setVal" type="number" placeholder="e.g. 1000" min="0" />
          <button class="btn" id="apply">Apply</button>
        </div>
      </div>

      <div>
        <label for="due">Due date</label>
        <div class="row" style="gap:12px">
          <div class="stat" id="dueStat">Due date: --</div>
          <input id="due" type="date" />
          <button class="btn" id="setDue">Set date</button>
          <button class="btn" id="renew">Renew +1 month</button>
        </div>
      </div>

      <div>
        <label>Sent Messages</label>
        <div class="table-container">
          <table class="data-table" id="messagesTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Sender</th>
                <th>Recipients</th>
                <th>Message</th>
                <th>Credits Used</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="messagesBody">
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <label>System Logs</label>
        <div class="list" id="logs"></div>
      </div>

      <div>
        <label>Delivery Status</label>
        <div class="table-container">
          <table class="data-table" id="deliveriesTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Message ID</th>
                <th>Recipient</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="deliveriesBody">
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <label>Blocked Sender IDs</label>
        <div class="row" style="margin-bottom:8px">
          <input id="newSender" type="text" placeholder="Enter sender ID to block" style="flex:1; background:#0d1117; border:1px solid #283142; color:#eaf0f6; padding:10px 12px; border-radius:10px; font-size:14px" />
          <button class="btn" id="addSender">Add</button>
        </div>
        <div class="list" id="blockedSendersList" style="max-height:200px"></div>
      </div>
    </div>
  </div>

  <script>
    const creditsEl = document.getElementById('credits');
    const refreshEl = document.getElementById('refresh');
    const setValEl = document.getElementById('setVal');
    const applyEl = document.getElementById('apply');
    const logsEl = document.getElementById('logs');
    const dueStat = document.getElementById('dueStat');
    const dueInput = document.getElementById('due');
    const setDueBtn = document.getElementById('setDue');
    const renewBtn = document.getElementById('renew');
    const messagesBody = document.getElementById('messagesBody');
    const deliveriesBody = document.getElementById('deliveriesBody');
    const newSenderEl = document.getElementById('newSender');
    const addSenderBtn = document.getElementById('addSender');
    const blockedSendersList = document.getElementById('blockedSendersList');

    let authHeader = '';
    // Login modal UI
  </script>

  <!-- Login modal overlay -->
  <div id="loginModal" style="position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:9998; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1f2a; border:1px solid #283142; color:#eaf0f6; padding:24px; border-radius:12px; max-width:420px; width:90%;">
      <h2 style="color:#77bdfb; margin-bottom:12px; text-align:center;">Admin Login</h2>
      <div style="display:grid; gap:10px;">
        <div>
          <label>Username</label>
          <input id="lu" type="text" style="width:100%; background:#0d1117; border:1px solid #283142; color:#eaf0f6; padding:10px 12px; border-radius:10px;">
        </div>
        <div>
          <label>Password</label>
          <input id="lp" type="password" style="width:100%; background:#0d1117; border:1px solid #283142; color:#eaf0f6; padding:10px 12px; border-radius:10px;">
        </div>
        <button class="btn" id="loginBtn">Login</button>
        <div class="error" id="loginErr" style="display:none; text-align:center;">Invalid credentials</div>
      </div>
    </div>
  </div>

  <script>
    function buildAuth(user, pass){
      return 'Basic ' + btoa(user + ':' + pass);
    }
    async function loadCredits(){
      const r = await fetch('/api/credits', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      creditsEl.textContent = 'Current credits: ' + (d.credits ?? '--');
    }
    function isoToDateOnly(iso){
      try{ return new Date(iso).toISOString().slice(0,10); }catch{ return ''; }
    }
    async function loadSubscription(){
      const r = await fetch('/api/subscription', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      if (d.ok){
        dueStat.textContent = 'Due date: ' + (d.dueDate ? d.dueDate : '--') + (d.isExpired ? ' (expired)' : '');
        if (d.dueDate) dueInput.value = isoToDateOnly(d.dueDate);
      }
    }
    async function loadLogs(){
      const r = await fetch('/api/logs', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      logsEl.innerHTML = '';
      (d.logs||[]).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span class="type">[${item.type}]</span>${item.time} â€” ` +
                        (item.type==='batch_send' ?
                          `sender=${item.sender} count=${item.count} success=${item.success} creditsAfter=${item.creditsAfter} msg="${(item.messagePreview||'').replace(/</g,'&lt;')}"`
                          : (item.type==='set_due_date' ?
                              `dueDate=${item.dueDate}`
                              : (item.type==='renew_month' ? `old=${item.oldDueDate||'-'} -> new=${item.newDueDate}`
                                : (item.type==='cost_adjustment' ? `messageId=${item.messageId} originalCredits=${item.originalCredits} costBasedCredits=${item.costBasedCredits} costUSD=${item.costUSD}`
                                  : `creditsAfter=${item.creditsAfter}`
                                )
                              )
                            )
                        );
        logsEl.appendChild(div);
      });
    }

    async function loadMessages(){
      const r = await fetch('/api/logs', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      messagesBody.innerHTML = '';
      
      // Filter only batch_send logs and display as table rows
      (d.logs||[]).filter(item => item.type === 'batch_send').forEach(item=>{
        const row = document.createElement('tr');
        const time = new Date(item.time).toLocaleString();
        const message = (item.messagePreview || '').replace(/</g,'&lt;').substring(0, 50) + (item.messagePreview?.length > 50 ? '...' : '');
        const status = item.success > 0 ? 'Sent' : 'Failed';
        const statusClass = item.success > 0 ? 'status-sent' : 'status-failed';
        
        row.innerHTML = `
          <td>${time}</td>
          <td>${item.sender || '--'}</td>
          <td>${item.count || 0}</td>
          <td title="${(item.messagePreview || '').replace(/</g,'&lt;')}">${message}</td>
          <td>${item.totalCreditsUsed || item.msgCredits || '--'}</td>
          <td class="${statusClass}">${status}</td>
        `;
        messagesBody.appendChild(row);
      });
    }

    async function loadDeliveries(){
      const r = await fetch('/api/deliveries', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      deliveriesBody.innerHTML = '';
      
      (d.deliveries||[]).forEach(item=>{
        const row = document.createElement('tr');
        const time = new Date(item.time).toLocaleString();
        const status = item.status || 'Unknown';
        const statusClass = status.toLowerCase().includes('delivered') ? 'status-delivered' : 
                           status.toLowerCase().includes('undeliverable') ? 'status-undeliverable' : 
                           status.toLowerCase().includes('sent') ? 'status-sent' : 'status-pending';
        
        row.innerHTML = `
          <td>${time}</td>
          <td>${item.messageId || '--'}</td>
          <td>${item.recipient || '--'}</td>
          <td class="${statusClass}">${status}</td>
        `;
        deliveriesBody.appendChild(row);
      });
    }

    async function loadBlockedSenders(){
      const r = await fetch('/api/blocked-senders', { headers: { 'x-auth': authHeader } });
      const d = await r.json();
      blockedSendersList.innerHTML = '';
      
      (d.blockedSenders||[]).forEach(sender=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.innerHTML = `
          <span>${sender}</span>
          <button class="btn" style="background:#dc2626; padding:4px 8px; font-size:11px;" onclick="removeSender('${sender}')">Remove</button>
        `;
        blockedSendersList.appendChild(div);
      });
    }

    async function addSender(){
      const sender = newSenderEl.value.trim();
      if (!sender) return alert('Please enter a sender ID');
      
      addSenderBtn.disabled = true;
      addSenderBtn.textContent = 'Adding...';
      
      try {
        const r = await fetch('/api/blocked-senders/add', { 
          method:'POST', 
          headers:{'Content-Type':'application/json', 'x-auth': authHeader}, 
          body: JSON.stringify({ sender }) 
        });
        const d = await r.json();
        
        if (r.ok && d.ok) {
          newSenderEl.value = '';
          await loadBlockedSenders();
        } else {
          alert('Failed to add sender: ' + (d.error || 'Unknown error'));
        }
      } catch(e) {
        alert('Network error: ' + e.message);
      } finally {
        addSenderBtn.disabled = false;
        addSenderBtn.textContent = 'Add';
      }
    }

    async function removeSender(sender){
      if (!confirm(`Remove "${sender}" from blocked list?`)) return;
      
      try {
        const r = await fetch('/api/blocked-senders/remove', { 
          method:'POST', 
          headers:{'Content-Type':'application/json', 'x-auth': authHeader}, 
          body: JSON.stringify({ sender }) 
        });
        const d = await r.json();
        
        if (r.ok && d.ok) {
          await loadBlockedSenders();
        } else {
          alert('Failed to remove sender: ' + (d.error || 'Unknown error'));
        }
      } catch(e) {
        alert('Network error: ' + e.message);
      }
    }

    refreshEl.addEventListener('click', ()=>{ loadCredits(); loadSubscription(); loadLogs(); loadMessages(); loadDeliveries(); loadBlockedSenders(); });
    applyEl.addEventListener('click', async ()=>{
      const val = Number(setValEl.value);
      if(!Number.isFinite(val) || val<0) return alert('Please enter a non-negative integer');
      applyEl.disabled = true; applyEl.textContent = 'Applying...';
      try{
        const r = await fetch('/api/credits/set', { method:'POST', headers:{'Content-Type':'application/json', 'x-auth': authHeader}, body: JSON.stringify({ credits: Math.floor(val) }) });
        const d = await r.json();
        if(r.ok && d.ok){
          await loadCredits();
        } else {
          alert('Failed to set credits: '+ (d.error||'Unknown error'));
        }
      } catch(e){ alert('Network error: '+ e.message); }
      finally{ applyEl.disabled=false; applyEl.textContent='Apply'; }
    });

    setDueBtn.addEventListener('click', async ()=>{
      const val = dueInput.value; // yyyy-mm-dd
      if (!val) return alert('Pick a date first');
      setDueBtn.disabled = true; setDueBtn.textContent = 'Setting...';
      try{
        const r = await fetch('/api/due-date/set', { method:'POST', headers:{'Content-Type':'application/json', 'x-auth': authHeader}, body: JSON.stringify({ dueDate: val }) });
        const d = await r.json();
        if(r.ok && d.ok){
          await loadSubscription();
        } else {
          alert('Failed to set date: ' + (d.error || 'Unknown error'));
        }
      }catch(e){ alert('Network error: ' + e.message); }
      finally{ setDueBtn.disabled=false; setDueBtn.textContent='Set date'; }
    });

    renewBtn.addEventListener('click', async ()=>{
      renewBtn.disabled = true; renewBtn.textContent = 'Renewing...';
      try{
        const r = await fetch('/api/due-date/renew-month', { method:'POST', headers: { 'x-auth': authHeader } });
        const d = await r.json();
        if(r.ok && d.ok){
          await loadSubscription();
        } else {
          alert('Failed to renew: ' + (d.error || 'Unknown error'));
        }
      }catch(e){ alert('Network error: ' + e.message); }
      finally{ renewBtn.disabled=false; renewBtn.textContent='Renew +1 month'; }
    });

    // Blocked senders event listeners
    addSenderBtn.addEventListener('click', addSender);
    newSenderEl.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addSender(); });

    // Login flow
    const loginModal = document.getElementById('loginModal');
    const lu = document.getElementById('lu');
    const lp = document.getElementById('lp');
    const loginBtn = document.getElementById('loginBtn');
    const loginErr = document.getElementById('loginErr');
    async function tryLogin(){
      loginErr.style.display = 'none';
      authHeader = buildAuth(lu.value.trim(), lp.value.trim());
      const r = await fetch('/api/credits', { headers: { 'x-auth': authHeader } });
      if (r.status === 200) {
        loginModal.style.display = 'none';
        loadCredits(); loadSubscription(); loadLogs(); loadMessages(); loadDeliveries(); loadBlockedSenders();
      } else {
        authHeader = '';
        loginErr.style.display = 'block';
      }
    }
    loginBtn.addEventListener('click', tryLogin);
    lp.addEventListener('keypress', (e)=>{ if(e.key==='Enter') tryLogin(); });
  </script>
</body>
</html>


